# 前言

此指南目的在于给想要自己添加测试项的开发者一个快速入门的机会。如果你是一个使用者，而非开发者，那么看到这里你可以关掉本文章了。
本文章仅作抛砖引玉，有更好的外接脚本方法可以进行讨论，谁都可以做开源贡献。
# 基础要求
想要新增流媒体测试项，首先需要一定的python基础知识。学会核心基础模块，异步库： aiohttp [官方文档](https://docs.aiohttp.org/en/stable/)

# 开始编写

可以看看项目中的hbomax、bahamut是咋写的，做到触类旁通就好。
首先分为，三个部分：采集数据函数，后续清洗数据函数、以及创建协程任务，以下为模板。
* 在addons文件夹下新建一个py文件,如 XXX.py ,xxx是随便取的名字，一般对应流媒体的名字即可。然后在这个文件里编写相关函数。


* 模块导入


基本的模块导入
```
import asyncio # 异步io模块
import aiohttp # 爬取网页要用
from aiohttp import ClientConnectorError # 错误处理
from loguru import logger # 日志
from pyrogram.types import InlineKeyboardButton # bot内联按钮
```

* 采集函数
```python function
async def fetch_XXX(Collector, session: aiohttp.ClientSession, proxy=None, reconnection=2):
    """
    XXX检测, XXX是流媒体的名字
    :param Collector: 采集器，来自 libs.collector.Collector() 类
    :param session: session，来自 aiohttp.ClientSession() 类
    :param proxy: 默认None即可，采集器会设置代理，这里不用设代理。
    :param reconnection: 重连次数，如果网络不稳定可能会造成请求失败，所以会有重新发送请求机制，默认为2
    :return: 不返回数据，所有数据维护在 Collector.info 属性中，它是一个字典。
    """
    try:
        # 这里写下你的测试逻辑
        async with session.get(_url, proxy=proxy, timeout=5) as reqs:
            Collector.info['XXX'] = "解锁" # 将数据放入字典中
    except ClientConnectorError as c:
        logger.warning("XXX请求发生错误:" + str(c))
        if reconnection != 0:
            await fetch_XXX(Collector, session=session, proxy=proxy, reconnection=reconnection - 1)
    except asyncio.exceptions.TimeoutError:
        logger.warning("XXX请求超时，正在重新发送请求......")
        if reconnection != 0:
            await fetch_XXX(Collector, session=session, proxy=proxy, reconnection=reconnection - 1)
```
采集函数是测试核心，怎样设计就看你python的功底了。
* 数据清洗

如果你在采集阶段就得到了测试的结果，那么这步就比较简单。这一步主要是为了获取干净的测试数据

```
def get_XXX_info(ReCleaner):
    """
    获得XXX解锁信息
    :param ReCleaner: 来自 libs.cleaner.ReClener() 类
    :return: str: 解锁信息: [解锁(地区代码)、失败、N/A等等]
    """
    try:
        if 'XXX' not in ReCleaner.data:
            logger.warning("采集器内无数据")
            return "N/A"
        else:
            logger.info("XXX解锁情况：" + str(ReCleaner.data.get('netflix_new', "N/A")))
            return ReCleaner.data.get('netflix_new', "N/A")
    except Exception as e:
        logger.error(e)
        return "N/A"
```

* 创建协程任务
```
def task(Collector, session, proxy):
    return asyncio.create_task(fetch_XXX(Collector, session, proxy=proxy))
```

* bot内联按钮

```
XXXbutton = InlineKeyboardButton("✅XXX", callback_data='✅XXX') #✅符号是重要的，请勿去掉。
```

# 项目源代码修改

做好以上工作后，我们通过修改一丢丢源代码即可做到内嵌入新的流媒体测试项啦。仅需要修改以下文件：libs.collector.py、 libs.collector.py、
libs.botmodule.command.setting.py

* collector.py

第233行开始，你会看到一个很多分支的if语句，同样只需新增一个elif 分支即可,注意代码缩进对齐:
```
    elif i == "XXX":
        from addons import XXX
        self.tasks.append((XXX.task(self, session, proxy=proxy)))
```

* cleaner.py

第543行开始,同样你会看到一个很多分支的if语句，同样只需新增一个elif 分支即可,注意代码缩进对齐:
```
    elif i == "XXX":
        from addons import XXX
        info['XXX'] = XXX.get_XXX_info(self)
```

* setting.py

文件开头导入按钮:
```
from addons import XXX.XXXbutton as XXX
```

第23行
```
# 加一个变量到方括号里(即XXX),加哪里都可以，只是位置不同
IKM = InlineKeyboardMarkup(
    [
        # 第一行
        [b1, b2, b3],
        # 第二行
        [b4, b5, b9],
        [b10, b11, XXX],
        [yusanjia, b_alive],
        [b_cancel, b8]
    ]
)
```

第58行:

```
# 加一个变量到括号里
    buttonss = [b1, b2, b3, b4, b5, b8, b9, b10, b11, yusanjia, XXX]
```
第82和103行同理:

```
# 加一个变量到括号里
    IKM2 = InlineKeyboardMarkup(
    [
        # 第一行
        [b1, b2, b3],
        # 第二行
        [b4, b5, b9],
        [b10, b11],
        [yusanjia, b_alive],
        [XXX],# 在这里加可以另起一行
        [b_cancel, b8]
    ]
)
```

至此，已完成全部工作，可以开始测试是否正常了。